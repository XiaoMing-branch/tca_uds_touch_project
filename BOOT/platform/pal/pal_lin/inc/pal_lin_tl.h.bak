/**
 *****************************************************************************
 * @brief   pal lin tl header file.
 *
 * @file    pal_lin_tl.h
 * @author  AE/FAE team
 * @date    2024.01.01
 *****************************************************************************
 *
 * THE PRESENT FIRMWARE WHICH IS FOR GUIDANCE ONLY AIMS AT PROVIDING CUSTOMERS
 * WITH CODING INFORMATION REGARDING THEIR PRODUCTS IN ORDER FOR THEM TO SAVE
 * TIME. AS A RESULT, TINYCHIP SHALL NOT BE HELD LIABLE FOR ANY
 * DIRECT, INDIRECT OR CONSEQUENTIAL DAMAGES WITH RESPECT TO ANY CLAIMS ARISING
 * FROM THE CONTENT OF SUCH FIRMWARE AND/OR THE USE MADE BY CUSTOMERS OF THE
 * CODING INFORMATION CONTAINED HEREIN IN CONNECTION WITH THEIR PRODUCTS.
 *
 * <b>&copy; Copyright (c) 2024 Tinychip Microelectronics Co.,Ltd.</b>
 *
 *****************************************************************************
 */

#ifndef __PAL_LIN_TL_H__
#define __PAL_LIN_TL_H__

#include <stdint.h>
#include <stdbool.h>

#ifdef __cplusplus
extern "C"
{
#endif


#define POSITIVE 1
#define NEGATIVE 0

#define LIN_BROADCAST_NAD                     0x7F   /**< NAD */
#define LIN_RES_NEGATIVE                      0x7F      /**< negative response */

/**
 * @brief lin negative response
 */
#define RES_NEGATIVE                        0x7F      /* negative response */
#define GENERAL_REJECT                      0x10      /*Error code raised when request for service not supported comes  */
#define SERVICE_NOT_SUPPORTED               0x11      /*not supported service */
#define SUBFUNCTION_NOT_SUPPORTED           0x12      /*not supported subfunction  */
#define IMLOIF                              0x13      /*incorrect Message LengtOr InvalidFormat*/
#define RESPONSE_TOO_LONG                   0x14      /*responseTooLong*/
#define BUSY_REPEAT_REQUEST                 0x21      /*busyRepeatRequest*/
#define CONDITION_NOT_CORRECT               0x22      /*conditionsNotCorrect*/
#define REQUEST_SEQUEENCE_ERROR             0x24      /*requestSequenceError*/
#define NRFSC                               0x25      /*no Response From Subnet Component*/
#define FPEORA                              0x26      /*Failure Prevents Execution Of Requested Action*/
#define REQUEST_OUT_RANGE                   0x31      /*request Out Of Range*/
#define SECURITY_ACCESS_DENIED              0x33      /*security Access Denied*/
#define INVALID_KEY                         0x35      /*invalid Key*/
#define ENOA                                0x36      /*exceed Number Of Attempts*/
#define REQUIREDTIMEDELAY_NOTEXPIRED        0x37      
#define RCRRP                               0x78      /*request Correctly Received-Response Pending*/
#define GENERAL_PROGRAM_FAILURE             0x72      /*general Programming Failure*/
#define SERVICENOTSUPPORTED_INACTIVESESSION 0x7F

/*-------------enum and struct---------------------------*/
/**
  * @brief  lin event type enumeration
  */
typedef enum
{
    LIN_EVENT_PID_OK,               /**< LIN_EVENT_PID_OK */
    LIN_EVENT_TX_COMPLETED,         /**< LIN_EVENT_TX_COMPLETED */
    LIN_EVENT_RX_COMPLETED,         /**< LIN_EVENT_RX_COMPLETED */
    LIN_EVENT_PID_ERR,              /**< LIN_EVENT_PID_ERR */
    LIN_EVENT_CHECKSUM_ERR,         /**< LIN_EVENT_CHECKSUM_ERR */

    LIN_EVENT_SYNC_VALUE_ERR,       /**< LIN_EVENT_SYNC_VALUE_ERR */
    LIN_EVENT_RX_PTY_CHK_ERR,       /**< LIN_EVENT_RX_PTY_CHK_ERR */
    LIN_EVENT_RX_TIMEOUT,           /**< LIN_EVENT_RX_TIMEOUT */
    LIN_EVENT_TX_RX_CONF,           /**< LIN_EVENT_TX_RX_CONF */
    LIN_EVENT_TX_PID_DONE,          /**< LIN_EVENT_TX_PID_DONE */
    LIN_EVENT_RX_BYTE,          /**< LIN_EVENT_RX_BYTE */
} lin_event_type_e;

/**
  * @brief  lin bus state enumeration
  */
typedef enum
{
    LIN_BUS_IDLE           = 0,
    LIN_BUS_SEND          = 1,
    LIN_BUS_RECV,
    LIN_BUS_ERROR,
} lin_bus_state_e;

/**
  * @brief  lin transport layer data
  */
typedef uint8_t lin_tl_data[8];

/**
  * @brief  lin packet struct
  */
typedef struct
{
    uint8_t id;
    uint8_t len;
    uint8_t buff[8];
} lin_packet_t;

/**
  * @brief  lin  transport layer queue struct
  */
typedef struct
{
    bool            ready;
    uint8_t         header;           /* the first element of queue */
    uint8_t         tail;             /* the last element of queue */
    uint16_t        frame_index;      /* the length of data */
    uint8_t         frame_byte;       /* the byte cnt of a frame */
    uint8_t         pid;              /* the pid of a frame */
    lin_tl_data     *tl_data;         /* the ptr of lin data */
} lin_tl_queue_t;

/**
  * @brief  lin  recv context struct
  */
typedef struct
{
    uint8_t         nad;
    uint8_t         pci;
    uint8_t         sid;
    uint16_t        remain_length;
    uint16_t        total_length;
    uint8_t         frame_index;
} lin_recv_context_t;

/*-------------Function port--------------------------*/
void lin_tl_init(void);
bool lin_uds_send(uint8_t nad, uint8_t *data, uint16_t length);
bool lin_uds_negative_response(uint8_t nad, uint8_t sid, uint8_t error_code);
bool lin_uds_receive(uint8_t nad, uint8_t *data, uint16_t *length);
bool lin_tl_uncd_frame_get(lin_bus_e bus, uint8_t *pid, uint8_t *buffer);
#ifdef __cplusplus
}
#endif
#endif
